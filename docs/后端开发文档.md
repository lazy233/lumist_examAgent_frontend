# LUMIST 学生端 - 后端开发文档

本文档根据前端功能归纳后端需实现的模块与接口，供后端开发对接。只说明核心约定，不展开实现细节。

---

## 一、通用约定

### 1.1 基础与鉴权

- **Base URL**：前端通过环境变量 `VITE_API_BASE_URL` 配置，默认 `/api`。所有接口均以此为前缀（如 `/api/auth/login`）。
- **鉴权方式**：除登录接口外，请求头需携带 `Authorization: Bearer <token>`。Token 由登录接口返回，前端持久化后每次请求自动带上。
- **401 处理**：后端返回 401 时，前端会清除本地 token 并跳转登录；错误体建议包含 `message` 供前端提示。

### 1.2 错误响应格式

- 建议统一结构：`{ "message": "错误描述" }`。前端会将 `message` 用于 ElMessage 提示。
- HTTP 状态码：4xx/5xx 表示失败；业务错误也可用 200 + 业务 code，由前端按约定解析。

### 1.3 分页

- 列表类接口统一使用 `page`、`pageSize` 查询参数（从 1 开始或从 0 开始需统一约定）。
- 响应建议包含 `items`（数组）和 `total`（总数）。

---

## 二、认证模块（Auth）

### 2.1 登录

- **接口**：`POST /auth/login`
- **鉴权**：不需要
- **请求体**：
  ```json
  { "username": "string", "password": "string" }
  ```
- **成功响应**：
  ```json
  {
    "token": "string",
    "user": { "id": "string", "name": "string" }
  }
  ```
- **说明**：前端仅使用 `user.id`、`user.name`；token 用于后续所有需鉴权接口。

---

## 三、资料模块（Docs）

### 3.1 上传文档

- **接口**：`POST /docs/upload`
- **Content-Type**：`multipart/form-data`
- **表单字段**：
  - `file`：必填，文件本体（支持 pdf / docx / pptx / txt，前端已做校验）
  - `saveToLibrary`：可选，`"true"` / `"false"`，是否存入用户资料库
- **成功响应**：
  ```json
  { "docId": "string", "fileName": "string", "status": "uploaded" }
  ```

### 3.2 发起解析

- **接口**：`POST /docs/:docId/parse`
- **成功响应**：
  ```json
  { "docId": "string", "status": "uploaded" | "parsing" | "done" | "failed" }
  ```
- **说明**：触发异步解析；解析进度/结果通过详情接口或 SSE 流获取。

### 3.3 文档详情

- **接口**：`GET /docs/:docId`
- **成功响应**：
  ```json
  {
    "docId": "string",
    "fileName": "string",
    "status": "uploaded" | "parsing" | "done" | "failed",
    "parsed": {
      "school": "string",
      "major": "string",
      "course": "string",
      "knowledgePoints": ["string"],
      "summary": "string"
    },
    "createdAt": "string"
  }
  ```
- **说明**：`parsed` 仅在 `status === "done"` 时存在且有意义；`createdAt` 建议 ISO 8601。

### 3.4 文档列表（我的资料）

- **接口**：`GET /docs`
- **查询参数**：`keyword`（可选）、`page`、`pageSize`
- **成功响应**：
  ```json
  {
    "items": [ /* 元素结构同 3.3 文档详情 */ ],
    "total": 0
  }
  ```

### 3.5 删除文档

- **接口**：`DELETE /docs/:docId`
- **成功**：204 或 200 无体均可；前端只关心成功/失败。

### 3.6 解析进度流（SSE）

- **接口**：`GET /docs/:docId/parse/stream`
- **说明**：前端使用 `EventSource` 订阅，用于文档详情页「解析中」的实时展示。浏览器 EventSource 无法自定义 Header，若需鉴权可考虑 URL 参数（如 `?token=xxx`）。
- **事件类型与 payload**：
  - **field**：`{ "name": "school"|"major"|"course"|"summary", "delta": "string" }` — 增量文本，前端按字段累加展示。
  - **knowledge_point**：`{ "delta": "string" }` — 单个知识点增量，前端追加到知识点列表。
  - **done**：`{ "status": "done"|"failed" }` — 解析结束；前端停止流并更新状态。
  - **error**：`{ "message": "string" }` — 解析失败原因；前端展示并置为 failed。

---

## 四、练习/出题模块（Exercises）

### 4.1 根据文字材料分析（出题中心 - 确认前）

- **接口**：`POST /exercises/analyze`
- **请求体**：
  ```json
  {
    "content": "string",
    "questionType": "string",
    "difficulty": "string",
    "count": 0
  }
  ```
- **说明**：`questionType` 与前端题型 value 一致（如 `single_choice`、`multiple_choice`、`true_false`、`fill_blank`、`short_answer`）；`difficulty` 为 `easy`/`medium`/`hard`。
- **成功响应**：
  ```json
  { "keyPoints": ["string"] }
  ```
- **说明**：大模型根据材料生成的「确认要点」，前端在确认弹窗中逐条展示；条数、内容由后端决定。

### 4.2 根据文字材料流式生成题目（出题中心 - 确认后）

- **接口**：`POST /exercises/generate-from-text`
- **请求体**：同 4.1（`content`、`questionType`、`difficulty`、`count`）。
- **响应**：`Transfer-Encoding: chunked` 的**纯文本流**。内容为题目正文（如 Markdown 或纯文本），前端边收边展示；流结束后可在**最后一行**追加一行 JSON，供前端解析 `exerciseId`：
  ```text
  ...题目正文...
  {"exerciseId":"xxx"}
  ```
- **说明**：若最后一行能解析为 `{ "exerciseId": "string" }`，前端会用于「查看全部题目」跳转至该练习详情；否则跳转练习列表。流式过程中前端仅展示前 N 字（如 800），完成后展示全文。

### 4.3 根据文档生成题目（资料详情页）

- **接口**：`POST /exercises/generate`
- **请求体**：
  ```json
  {
    "docId": "string",
    "types": ["single_choice", "fill_blank", "short_answer"],
    "difficulty": "easy" | "medium" | "hard",
    "count": 0
  }
  ```
- **成功响应**：
  ```json
  { "exerciseId": "string", "status": "generating" }
  ```
- **说明**：异步生成；前端轮询 4.5 练习详情，根据 `status` 为 `ready` / `failed` 决定跳转或提示失败。

### 4.4 练习详情

- **接口**：`GET /exercises/:exerciseId`
- **成功响应**：
  ```json
  {
    "exerciseId": "string",
    "title": "string",
    "status": "generating" | "ready" | "failed",
    "difficulty": "easy" | "medium" | "hard",
    "count": 0,
    "questions": [
      {
        "questionId": "string",
        "type": "single_choice" | "multiple_choice" | "true_false" | "fill_blank" | "short_answer",
        "stem": "string",
        "options": { "A": "string", "B": "string", ... }
      }
    ],
    "createdAt": "string",
    "score": 0
  }
  ```
- **说明**：`options` 仅选择题有；简答题/填空题为空或省略。`score` 为提交后才有；未提交时可不返回或为 null。

### 4.5 提交答案

- **接口**：`POST /exercises/:exerciseId/submit`
- **请求体**：
  ```json
  { "answers": [ { "questionId": "string", "answer": "string" } ] }
  ```
- **成功响应**：
  ```json
  {
    "score": 0,
    "correctRate": 0,
    "results": [
      {
        "questionId": "string",
        "isCorrect": true,
        "userAnswer": "string",
        "correctAnswer": "string",
        "analysis": "string"
      }
    ]
  }
  ```

### 4.6 练习列表（我的练习）

- **接口**：`GET /exercises`
- **查询参数**：`keyword`、`difficulty`、`page`、`pageSize`
- **成功响应**：
  ```json
  {
    "items": [
      {
        "exerciseId": "string",
        "title": "string",
        "count": 0,
        "difficulty": "easy" | "medium" | "hard",
        "score": 0,
        "createdAt": "string",
        "status": "generating" | "ready" | "failed"
      }
    ],
    "total": 0
  }
  ```

---

## 五、未对接或占位功能

- **个人中心**：当前「保存资料」「修改密码」仅前端占位，未调用后端；若后续需要，可补充 `PATCH /user/profile`、`POST /auth/change-password` 等接口并在本文档中扩展。

---

## 六、模块与接口总览

| 模块   | 方法   | 路径                              | 说明                     |
|--------|--------|-----------------------------------|--------------------------|
| 认证   | POST   | `/auth/login`                     | 登录，返回 token + user  |
| 资料   | POST   | `/docs/upload`                    | 上传文档                 |
| 资料   | POST   | `/docs/:docId/parse`              | 发起解析                 |
| 资料   | GET    | `/docs/:docId`                    | 文档详情                 |
| 资料   | GET    | `/docs`                           | 文档列表                 |
| 资料   | DELETE | `/docs/:docId`                    | 删除文档                 |
| 资料   | GET    | `/docs/:docId/parse/stream`       | 解析进度 SSE 流          |
| 练习   | POST   | `/exercises/analyze`              | 文字材料分析（确认用）    |
| 练习   | POST   | `/exercises/generate-from-text`   | 文字材料流式出题         |
| 练习   | POST   | `/exercises/generate`             | 按文档生成题目           |
| 练习   | GET    | `/exercises/:exerciseId`         | 练习详情                 |
| 练习   | POST   | `/exercises/:exerciseId/submit`   | 提交答案                 |
| 练习   | GET    | `/exercises`                      | 练习列表                 |

以上覆盖当前前端所有模块与接口；实现时以本文档为准，若有字段增删可与前端对齐后同步更新此文档。
